<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Jarvis AI</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000000; font-family: 'Segoe UI', sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; display: block; }
        
        /* UI Overlay */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #status-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 24px;
            font-weight: 300;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-top: 350px; /* Position below the sphere */
            transition: all 0.5s ease;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        /* Dynamic States */
        .listening { color: #00ffcc !important; text-shadow: 0 0 20px #00ffcc !important; }
        .processing { color: #00aaff !important; text-shadow: 0 0 20px #00aaff !important; }
        .speaking { color: #aa00ff !important; text-shadow: 0 0 20px #aa00ff !important; }

    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="status-text">Initializing...</div>
    </div>
    <div id="canvas-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplex-noise/2.4.0/simplex-noise.min.js"></script>

    <script>
        // --- Global State Controlled by Python ---
        let targetAmplitude = 0;
        let currentAmplitude = 0;
        let coreColor = new THREE.Color(0x444444); // Default Idle Color

        // --- Three.js Setup ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // Lighting
        const ambientLight = new THREE.AmbientLight(0x222222);
        scene.add(ambientLight);
        const pointLight = new THREE.PointLight(0xffffff, 1, 100);
        pointLight.position.set(10, 10, 10);
        scene.add(pointLight);

        // The "Siri" Sphere
        const geometry = new THREE.SphereGeometry(1.8, 128, 128);
        const material = new THREE.MeshPhysicalMaterial({
            color: 0x111111,
            metalness: 0.9,
            roughness: 0.1,
            transmission: 0.2,
            emissive: 0x000000,
            emissiveIntensity: 0.5,
            wireframe: true
        });
        const sphere = new THREE.Mesh(geometry, material);
        scene.add(sphere);

        camera.position.z = 5;
        const simplex = new SimplexNoise();

        // --- Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now() * 0.001;

            // Smoothly interpolate amplitude (prevents jittery 3D mesh)
            currentAmplitude += (targetAmplitude - currentAmplitude) * 0.1;

            // Dynamic Color Transition
            sphere.material.emissive.lerp(coreColor, 0.1);
            
            // Vertex Distortion (Liquid Effect)
            const positionAttribute = geometry.attributes.position;
            const vertex = new THREE.Vector3();
            
            // Optimize: Only update every 2nd frame if slow, but modern GPUs handle this fine
            for (let i = 0; i < positionAttribute.count; i++) {
                vertex.fromBufferAttribute(positionAttribute, i);
                const direction = vertex.clone().normalize();
                
                // Noise based on time + amplitude
                const noiseBase = simplex.noise3D(vertex.x * 0.5 + time, vertex.y * 0.5 + time, vertex.z * 0.5 + time);
                
                // Idle breathing vs Active talking
                const distortion = 1 + (noiseBase * (0.1 + currentAmplitude * 0.8));
                
                vertex.copy(direction).multiplyScalar(distortion);
                positionAttribute.setXYZ(i, vertex.x, vertex.y, vertex.z);
            }
            
            positionAttribute.needsUpdate = true;
            geometry.computeVertexNormals();
            
            // Slow rotation
            sphere.rotation.y += 0.002;
            sphere.rotation.z += 0.001;

            renderer.render(scene, camera);
        }
        animate();

        // --- Python Bridge Functions ---
        
        // Called by Python to update volume (0.0 to 1.0)
        window.setAmplitude = (val) => {
            targetAmplitude = val * 2.0; // Scale up effect
        }

        // Called by Python to change status text and color
        window.setStatus = (text, type) => {
            const el = document.getElementById('status-text');
            el.innerText = text;
            el.className = type; // listening, processing, speaking
            
            // Update Sphere Color based on state
            if (type === 'listening') coreColor.setHex(0x00ffcc); // Cyan
            else if (type === 'processing') coreColor.setHex(0x00aaff); // Blue
            else if (type === 'speaking') coreColor.setHex(0xaa00ff); // Purple
            else coreColor.setHex(0x444444); // Grey
        }

        // Resize Handler
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>